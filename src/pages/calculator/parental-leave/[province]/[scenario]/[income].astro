---
// src/pages/calculator/parental-leave/[province]/[scenario]/[income].astro

// 1. IMPORTS
import BaseLayout from '../../../../../layouts/BaseLayout.astro';
import ParentalLeave from '../../../../../features/parental-leave/components/ParentalLeave.jsx';
import Breadcrumbs from '../../../../../components/shared/Breadcrumbs.astro';
import { PROVINCES, SALARIES, LEAVE_SCENARIOS } from '../../../../../data/seo-scenarios';

// 2. IMPORT ENGINE (Server-Side)
import { calculateParentalLeave } from '../../../../../features/parental-leave/utils/parentalLeaveEngine.js';

export const prerender = true;

// 3. GENERATE PATHS
export async function getStaticPaths() {
  const paths = [];
  PROVINCES.forEach((prov) => {
    LEAVE_SCENARIOS.forEach((scene) => {
        SALARIES.forEach((salary) => {
            paths.push({
                params: { 
                    province: prov.slug, 
                    scenario: scene.slug,
                    income: salary.toString() 
                },
                props: { 
                    provinceCode: prov.code, 
                    provinceName: prov.name, 
                    salaryVal: salary,
                    scenarioLabel: scene.label,
                    scenarioSlug: scene.slug, // Needed for linking
                    planType: scene.plan,
                    hasPartner: scene.partner
                },
            });
        });
    });
  });
  return paths;
}

const { provinceCode, provinceName, salaryVal, scenarioLabel, scenarioSlug, planType, hasPartner } = Astro.props;

// 4. SERVER-SIDE CALCULATION
// We run the math immediately so Google sees the result in the HTML
const serverResults = calculateParentalLeave({
    province: provinceCode,
    salary: salaryVal,
    partnerSalary: hasPartner ? 60000 : 0, // Assume generic partner income for SEO snapshot
    hasPartner: hasPartner,
    planType: planType,
    p1Weeks: planType === 'EXTENDED' ? 61 : 35, // Default to max for that plan
    p2Weeks: hasPartner ? (planType === 'EXTENDED' ? 8 : 5) : 0, // Default to max bonus
    p1Maternity: true
});

// 5. FORMATTERS
const currency = new Intl.NumberFormat('en-CA', { style: 'currency', currency: 'CAD', maximumFractionDigits: 0 });
const salaryFormatted = currency.format(salaryVal);
const weeklyPay = currency.format(serverResults.p1Weekly);
const totalValue = currency.format(serverResults.totalValue);

// 6. DYNAMIC INSIGHTS (Unique Descriptions)
let insightText = "";
if (salaryVal >= 66600 && provinceCode !== 'QC') {
    insightText = `Since your income exceeds the $66,600 maximum insurable earnings, your benefit is capped at the highest possible rate.`;
} else {
    insightText = `Your benefit is calculated directly as ${planType === 'EXTENDED' ? '33%' : '55%'} of your ${salaryFormatted} income.`;
}

if (hasPartner) {
    insightText += ` This estimate includes the "Sharing Bonus" weeks available when both parents take leave.`;
}

// 7. SEO METADATA
const durationText = planType === 'EXTENDED' ? '18 months' : '12 months';
const title = `EI Payment Estimate: ${weeklyPay}/wk for ${salaryFormatted} Income in ${provinceName} | LoonieFi`;
const description = `With an income of ${salaryFormatted}, you qualify for approx. ${weeklyPay} per week on the ${durationText} plan. ${insightText}`;
const canonicalURL = new URL(Astro.url.pathname, Astro.site || Astro.url.origin);

// Breadcrumbs
const breadcrumbPath = [
  { label: 'Mat. Leave', href: '/parental-leave-calculator' },
  { label: provinceName, href: `/calculator/parental-leave/browse` },
  { label: `${scenarioLabel} (${salaryFormatted})`, href: Astro.url.pathname }
];

// 8. LINKING STRATEGY
const step = 5000;
const prevIncome = parseInt(salaryVal) - step;
const nextIncome = parseInt(salaryVal) + step;
const makeUrl = (inc) => `/calculator/parental-leave/${Astro.params.province}/${scenarioSlug}/${inc}`;

// 9. SCHEMA
const faqSchema = {
  "@context": "https://schema.org",
  "@type": "FAQPage",
  "mainEntity": [
    {
      "@type": "Question",
      "name": `How much is EI maternity pay for a ${salaryFormatted} salary in ${provinceName}?`,
      "acceptedAnswer": {
        "@type": "Answer",
        "text": `Based on 2025 rates, a parent in ${provinceName} earning ${salaryFormatted} would receive approximately ${weeklyPay} per week on the ${planType.toLowerCase()} plan.`
      }
    }
  ]
};

const calculatorSchema = {
  "@context": "https://schema.org",
  "@type": "WebApplication",
  "name": title,
  "description": description,
  "url": canonicalURL.toString(),
  "applicationCategory": "FinanceApplication",
  "offers": { "@type": "Offer", "price": "0", "priceCurrency": "CAD" },
};
---

<BaseLayout title={title} description={description}>
  <script type="application/ld+json" set:html={JSON.stringify(calculatorSchema)} />
  <script type="application/ld+json" set:html={JSON.stringify(faqSchema)} />
  
  <main>
    <section class="py-12 px-4 max-w-5xl mx-auto">
      <Breadcrumbs crumbs={breadcrumbPath} />

      <header class="text-center mb-10">
        <h1 class="text-3xl md:text-4xl font-black text-slate-900 mb-4">
            {scenarioLabel} in <span class="text-rose-600">{provinceName}</span>
        </h1>
        <p class="text-lg text-slate-600 max-w-2xl mx-auto">
            Estimating 2025 EI benefits for an income of <strong>{salaryFormatted}</strong>.
        </p>
      </header>

      {/* --- SERVER-SIDE RESULT PREVIEW (SEO GOLD) --- */}
      {/* Google sees this Div. Users see it for 0.5s before React loads. */}
      <div id="static-seo-result" class="bg-rose-50 border border-rose-100 rounded-3xl p-8 mb-12 text-center relative overflow-hidden">
         <div class="relative z-10">
             <p class="text-xs font-black text-rose-400 uppercase tracking-widest mb-2">Estimated Weekly Payment</p>
             <div class="text-5xl md:text-6xl font-black text-slate-900 mb-2 tracking-tighter">
                 {weeklyPay}
                 <span class="text-lg text-slate-400 font-medium">/wk</span>
             </div>
             <p class="text-sm text-slate-500 font-medium">
                 Total Household Value: ~{totalValue} (Gross)
             </p>
         </div>
         <div class="absolute top-0 left-1/2 -translate-x-1/2 w-64 h-64 bg-rose-500/5 rounded-full blur-3xl -mt-10"></div>
      </div>

      <ParentalLeave 
        client:load 
        initialProvince={provinceCode} 
        initialSalary={salaryVal} 
        initialPlan={planType}
        initialPartner={hasPartner}
      />

      {/* --- DYNAMIC CONTENT (Unique Descriptions) --- */}
      <div class="prose prose-slate mx-auto mt-16 bg-white p-8 rounded-3xl border border-slate-100 shadow-sm">
        <h2>About Your Estimate</h2>
        <p>{description}</p>
        
        <h3>How it was calculated</h3>
        <p>
            You selected the <strong>{planType === 'EXTENDED' ? 'Extended (18 Month)' : 'Standard (12 Month)'}</strong> option. 
            Residents of <strong>{provinceName}</strong> are subject to {provinceCode === 'QC' ? 'QPIP' : 'Federal EI'} rules.
        </p>
        <ul>
            <li><strong>Weekly Payment:</strong> Approximately {weeklyPay} per parent (if earnings are similar).</li>
            <li><strong>Total Duration:</strong> Up to {hasPartner ? (planType === 'EXTENDED' ? '69' : '40') : (planType === 'EXTENDED' ? '61' : '35')} weeks combined.</li>
        </ul>
      </div>

      {/* --- HORIZONTAL LINKING (Spiderweb) --- */}
      <div class="mt-16 pt-10 border-t border-slate-200">
          <h3 class="font-bold text-slate-900 mb-6 text-center">Compare Nearby Salaries</h3>
          <div class="flex flex-wrap justify-center gap-3">
            {prevIncome >= 30000 && (
                <a href={makeUrl(prevIncome)} class="px-5 py-3 bg-white border border-slate-200 hover:border-rose-300 hover:text-rose-600 rounded-xl text-sm font-bold transition-all shadow-sm">
                    ← {currency.format(prevIncome)} Income
                </a>
            )}
            {nextIncome <= 150000 && (
                <a href={makeUrl(nextIncome)} class="px-5 py-3 bg-white border border-slate-200 hover:border-rose-300 hover:text-rose-600 rounded-xl text-sm font-bold transition-all shadow-sm">
                    {currency.format(nextIncome)} Income →
                </a>
            )}
          </div>
      </div>

    </section>
  </main>
</BaseLayout>